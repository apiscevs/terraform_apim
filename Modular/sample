public static class LuaScriptRegistry
{
    private static IConnectionMultiplexer? _redisMux;
    private static readonly ConcurrentDictionary<string, AsyncLazy<RedisScript>> _scripts = new();
    private static bool _initialized = false;
    private static readonly object _lock = new();

    public static void Initialize(IConnectionMultiplexer redisMux)
    {
        if (_initialized) return;

        lock (_lock)
        {
            if (_initialized) return;

            _redisMux = redisMux;

            _scripts.TryAdd("ValidateMatchingTotals", new AsyncLazy<RedisScript>(() =>
                LoadScriptAsync("ValidateMatchingTotals", $@"
                    local deltaLender = tonumber(ARGV[1])
                    -- your full Lua logic here
                    return {{tostring(deltaLender)}}
                ")));

            // Add more scripts here...

            _initialized = true;
        }
    }

    private static async Task<RedisScript> LoadScriptAsync(string key, string script)
    {
        if (_redisMux == null)
            throw new InvalidOperationException("LuaScriptRegistry not initialized.");

        var db = _redisMux.GetDatabase();
        var sha = await db.ScriptLoadAsync(script).ConfigureAwait(false);
        return new RedisScript(script, sha);
    }

    public static Task<RedisScript> GetAsync(string key)
    {
        if (!_initialized)
            throw new InvalidOperationException("LuaScriptRegistry not initialized.");

        if (_scripts.TryGetValue(key, out var lazyScript))
            return lazyScript.GetValueAsync();

        throw new KeyNotFoundException($"Lua script '{key}' not registered.");
    }

    public static Task WarmUpAsync() => Task.WhenAll(_scripts.Values.Select(s => s.GetValueAsync()));
}

public record RedisScript(string Script, RedisKey Sha);